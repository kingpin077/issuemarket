<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  <!-- ë°˜ì‘í˜• ì›¹ì„ ìœ„í•œ ë·°í¬íŠ¸ ì„¤ì • -->
    <title>Issue Market</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Jua&family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/globals.css">
    <link rel="stylesheet" href="/css/keyword_style.css">
    <link rel="stylesheet" href="/css/searchKeyword.css">

    <!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° (ì°¨íŠ¸ ë Œë”ë§ì„ ìœ„í•´ ì‚¬ìš©) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
<div id="loadingOverlay" style="display: none;">
    <div class="spinner-container">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
        </div>
        <p class="loading-message">Downloading, please wait...</p>
    </div>
</div>
<div class="header-wrapper" id="header-wrapper">
    <div class="menu-button-wrapper">
        <button type="button" class="btn btn-light" id="menu-button">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#FFFFFF"><path d="M120-240v-80h720v80H120Zm0-200v-80h720v80H120Zm0-200v-80h720v80H120Z"/></svg>
        </button>
        <button class="issue-market-title btn btn-link d-flex align-items-center" id="issue-market-title">
            <span>&nbsp;Issue Market</span>
        </button>
    </div>

    <!-- ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì„¤ì • -->
    <div class="items">
        <form id="keywordForm" action="/searchKeyword" method="post" class="d-flex">
            <div class="header-input">
                <input type="text" id="keyword_search" name="keyword_search" class="form-control" placeholder="Enter keyword to search" required>
            </div>
            <button id="header-search">
                <div class="text-wrapper-12"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#FFFFFF"><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg></div>
            </button>
        </form>

        <button type="button" class="btn btn-danger" sec:authorize="hasAuthority('ADMIN')"
                onclick="location.href='/admin'">
            <div class="text-wrapper-17">Admin Page</div>
        </button>
        <button type="button" class="btn btn-dark" sec:authorize="isAuthenticated()" onclick="location.href='/logout'">
            <div class="text-wrapper-17">Log out</div>
        </button>
        <button type="button" class="btn btn-dark" sec:authorize="!isAuthenticated()" onclick="location.href='/login'">
            <div class="text-wrapper-17">Log in</div>
        </button>

        <div class="language-selector-wrapper">
            <select id="languageSelect" class="form-control" onchange="changeLanguage(this.value)">
                <option value="ko" th:attr="selected=${#locale == 'ko'}">í•œêµ­ì–´</option>
                <option value="en" th:attr="selected=${#locale == 'en'}">English</option>
            </select>
        </div>
    </div>
</div>

<div class="element-header-navigation">
    <div class="element-sidebar" id="sidebar">
        <div class="top-divider"></div> <!-- ì‚¬ì´ë“œë°” ë§¨ ìœ„ì— ì¶”ê°€ëœ ê²€ì€ ì¤„ -->
        <div class="list-3">
            <button class="menu-item" id="home-button">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#FFFFFF"><path d="M240-200h120v-240h240v240h120v-360L480-740 240-560v360Zm-80 80v-480l320-240 320 240v480H520v-240h-80v240H160Zm320-350Z"/></svg>
                <div class="text-wrapper-14">Home</div>
            </button>
            <button class="menu-item" id="movie-button">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#FFFFFF"><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg>
                <div class="text-wrapper-14">Movie</div>
            </button>
            <button class="menu-item" id="music-button">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#FFFFFF"><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg>
                <div class="text-wrapper-14">Music</div>
            </button>
            <button class="menu-item" id="actor-button">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#FFFFFF"><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg>
                <div class="text-wrapper-14">Actor</div>
            </button>
            <button class="menu-item" id="webtoon-button">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#FFFFFF"><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg>
                <div class="text-wrapper-14">Webtoon</div>
            </button>
        </div>
    </div>
</div>



<div id="results">
    <button id="excelButton" class="btn btn-primary">Download in Excel</button>
    <!-- ìƒë‹¨ ê°€ë¡œ 3ê°œ ì˜ì—­ -->
    <div class="row">
        <div class="col">
            <h3>Keyword Data</h3>
            <pre id="keywordData"></pre>
            <p id="keywordSearch" th:text="${keyword_search}"></p>
        </div>
        <div class="col">
            <h3>Gender Ratio</h3>
            <div class="chart-container">
                <canvas id="genderChart" width="500" height="350"></canvas>
            </div>
            <p id="gender-con"></p>
        </div>
        <div class="col">
            <h3>Age Ratio</h3>
            <div class="chart-container">
                <canvas id="ageChart" width="500" height="350"></canvas>
                <div class="chartcontainer-gender"></div>
            </div>
            <p id="age-con"></p>
        </div>
    </div>

    <!-- ì¤‘ê°„ì— 1ê°œ ì˜ì—­ -->
    <div class="full-width">
        <h3>Ratio Results (Estimated Value by Date)</h3>
        <div class="chart-container">
            <canvas id="ratioResultsChart" width="1450" height="350"></canvas>
        </div>
        <p id="ratio-con"></p>
    </div>

    <!-- í•˜ë‹¨ ê°€ë¡œ 2ê°œ ì˜ì—­ -->
    <div class="row">
        <div class="col" id="related_keyword">
            <h3>Related Keywords</h3>
            <div id="relatedKeywordsContainer" class="related-keywords"></div>
        </div>
        <div class="col">
            <h3>YouTube Video</h3>
            <br>
            <div id="youtubeData">
                <iframe id="youtubeVideoFrame" width="560" height="315" frameborder="0" allowfullscreen></iframe>
                <p id="youtubeViewCount"></p>
            </div>
        </div>
    </div>
</div>

<!-- ë‰´ìŠ¤ ê²°ê³¼ë¥¼ ì¶œë ¥í•˜ëŠ” ì˜ì—­ -->
<div id="newsResults">
    <div id="newsContainer"></div>  <!-- ë‰´ìŠ¤ ê¸°ì‚¬ë¥¼ ë‹´ëŠ” ì»¨í…Œì´ë„ˆ -->
</div>
<br>
<div class="overlay" id="overlay"></div>

<!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œ -->
<script th:inline="javascript">
    /*<![CDATA[*/
    const keyword_search = /*[[${keyword_search}]]*/ 'defaultKeyword';  // Thymeleafë¡œ ì „ë‹¬ëœ í‚¤ì›Œë“œ ë³€ìˆ˜ ì„¤ì •
    console.log(keyword_search);

    function saveKeyword(keyword) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/api/keywords", true); // í‚¤ì›Œë“œ ì¸ì½”ë”©
        xhr.setRequestHeader("Content-Type", "application/json");
        var data = JSON.stringify({keyword: keyword});

        xhr.onload = function () {
            if (xhr.status === 200) {
                console.log("Keyword saved successfully:", xhr.responseText);
            } else {
                console.error("Error saving keyword:", xhr.statusText);
            }
        };
        xhr.send(data);  // ìš”ì²­ ì „ì†¡
    }

    // í˜ì´ì§€ê°€ ë¡œë“œë  ë•Œ saveKeyword í˜¸ì¶œ
    document.addEventListener('DOMContentLoaded', function () {
        saveKeyword(keyword_search); // ê¸°ë³¸ í‚¤ì›Œë“œë¥¼ ì €ì¥
    });
    /*]]>*/
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const headerSearchButton = document.getElementById('header-search');
        const keywordForm = document.getElementById('keywordForm');

        headerSearchButton.addEventListener('click', function () {
            keywordForm.submit();
        });
    });

    let data = null;

    document.addEventListener('DOMContentLoaded', function () {
        // ìš”ì†Œ ì°¸ì¡° ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        var menuButton = document.getElementById('menu-button');
        var sidebar = document.getElementById('sidebar');
        var overlay = document.getElementById('overlay');
        var issueMarketTitle = document.getElementById('issue-market-title');
        var homeButton = document.getElementById('home-button');

        menuButton.addEventListener('click', function () {
            sidebar.classList.toggle('sidebar-visible');
            overlay.classList.toggle('overlay-visible');
        });

        overlay.addEventListener('click', function () {
            sidebar.classList.remove('sidebar-visible');
            overlay.classList.remove('overlay-visible');
        });

        document.getElementById('movie-button').addEventListener('click', function() {
            alert("ê°œë°œì¤‘ì¸ í˜ì´ì§€ ì…ë‹ˆë‹¤.");
        });

        document.getElementById('music-button').addEventListener('click', function() {
            alert("ê°œë°œì¤‘ì¸ í˜ì´ì§€ ì…ë‹ˆë‹¤.");
        });

        document.getElementById('actor-button').addEventListener('click', function () {
            window.location.href = '/actor'; // ë°°ìš° ë²„íŠ¼ í´ë¦­ ì‹œ actorë¡œ ì´ë™
        });

        document.getElementById('webtoon-button').addEventListener('click', function () {
            window.location.href = '/webtoon'; // ì›¹íˆ° ë²„íŠ¼ í´ë¦­ ì‹œ webtoonìœ¼ë¡œ ì´ë™
        });

        issueMarketTitle.addEventListener('click', function () {
            window.location.href = 'index'; // í™ˆ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
        });

        homeButton.addEventListener('click', function () {
            window.location.href = 'index'; // í™ˆ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
        });

        // ê²€ìƒ‰ì–´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë°ì´í„° í˜¸ì¶œ
        fetch(`/search?groupName=${keyword_search}&keywords=${keyword_search}`, {
            method: 'POST'
        })
            .then(response => response.json())   // JSON ì‘ë‹µì„ íŒŒì‹±
            .then(fetchedData => {
                data = fetchedData; // ì „ì—­ ë³€ìˆ˜ì— ë°ì´í„° ì €ì¥
                console.log(data); // ë°ì´í„°ë¥¼ ì½˜ì†”ì— ì¶œë ¥í•˜ì—¬ í™•ì¸

                // í‚¤ì›Œë“œ ë°ì´í„° ì¶œë ¥
                const keywordDataDiv = document.getElementById('keywordData');
                const pcCount = data.monthlyPcQcCnt;
                const mobileCount = data.monthlyMobileQcCnt;
                const totalCount = pcCount + mobileCount;

                // í‚¤ì›Œë“œ í†µê³„ ë°ì´í„°ë¥¼ í™”ë©´ì— í‘œì‹œ
                keywordDataDiv.innerHTML = `
                    <div class="keyword-stats">
                        <div class="stat-item">
                            <span class="device-icon">ğŸ’»</span>
                            <span class="stat-value">${pcCount.toLocaleString()}</span>
                            <span>PC</span>
                        </div>
                        <div class="stat-item">
                            <span class="device-icon">ğŸ“±</span>
                            <span class="stat-value">${mobileCount.toLocaleString()}</span>
                            <span>Mobile</span>
                        </div>
                        <div class="stat-item">
                            <span class="device-icon">ğŸ”</span>
                            <span class="stat-value">${totalCount.toLocaleString()}</span>
                            <span>Total</span>
                        </div>
                    </div>
            `;
                // ì—°ê´€ ê²€ìƒ‰ì–´ ë°ì´í„° í‘œì‹œ
                const relatedKeywordsContainer = document.getElementById('relatedKeywordsContainer');
                const relatedKeywords = data.relatedKeywords;

                if (relatedKeywords && Array.isArray(relatedKeywords) && relatedKeywords.length > 0) {
                    const ul = document.createElement('ul'); // <ul> íƒœê·¸ ìƒì„±

                    relatedKeywords.forEach((keyword, index) => {
                        const li = document.createElement('li'); // <li> íƒœê·¸ ìƒì„±
                        li.textContent = `${index + 1}. ${keyword}`; // ë²ˆí˜¸ì™€ í‚¤ì›Œë“œ ì¶”ê°€
                        ul.appendChild(li); // <li>ë¥¼ <ul>ì— ì¶”ê°€
                    });

                    relatedKeywordsContainer.appendChild(ul); // <ul>ì„ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
                } else {
                    relatedKeywordsContainer.innerText = "There is no data due to api's own problem.";
                }

                // ì„±ë³„ ë¹„ìœ¨ ì°¨íŠ¸ ë Œë”ë§
                const genderData = data.kakaoData.gender;
                const gendercon = document.getElementById('gender-con');
                if (genderData != null) {
                    const genderChart = new Chart(document.getElementById('genderChart'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Male', 'Female'],
                            datasets: [{
                                data: [genderData.male, genderData.female],
                                backgroundColor: ['#36A2EB', '#FF6384']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true
                        }
                    });
                } else {
                    console.error('Gender data is missing or invalid.');
                    gendercon.innerHTML = "There is no data due to api's own problem.";
                }

                // ì—°ë ¹ëŒ€ ë¹„ìœ¨ ì°¨íŠ¸ ë Œë”ë§
                const ageData = data.kakaoData.age;
                const agecon = document.getElementById('age-con');
                if (ageData) {
                    const ageChart = new Chart(document.getElementById('ageChart'), {
                        type: 'bar',
                        data: {
                            labels: Object.keys(ageData),
                            datasets: [{
                                label: 'Age Distribution',
                                data: Object.values(ageData),
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                } else {
                    console.error('Age data is missing or invalid.');
                    agecon.innerHTML = 'api ìì²´ ë¬¸ì œë¡œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
                }

                // ìœ íŠœë¸Œ ë°ì´í„° í‘œì‹œ ë¡œì§ ì¶”ê°€
                const youtubeData = data.youtubeData;
                if (youtubeData && !youtubeData.error) {
                    const youtubeVideoFrame = document.getElementById('youtubeVideoFrame');
                    const youtubeViewCountElement = document.getElementById('youtubeViewCount');

                    // ìœ íŠœë¸Œ ì„ë² ë“œ URL ì„¤ì •
                    const videoId = youtubeData.videoUrl.split("v=")[1];
                    const embedUrl = `https://www.youtube.com/embed/${videoId}`;
                    youtubeVideoFrame.src = embedUrl;

                    // ì¡°íšŒìˆ˜ í‘œì‹œ
                    youtubeViewCountElement.textContent = `View Count: ${youtubeData.viewCount.toLocaleString()}`;
                } else {
                    console.error('YouTube data is missing or invalid.');
                    document.getElementById('youtubeData').textContent = 'Failed to load YouTube data.';
                }

                // ë‰´ìŠ¤ API í˜¸ì¶œ
                fetch(`/news?query=${keyword_search}`)
                    .then(newsResponse => newsResponse.json())
                    .then(newsData => {
                        const newsContainer = document.getElementById('newsContainer');

                        // JSON íŒŒì‹± ë° ë°ì´í„° ì¶œë ¥
                        let naverData = null;
                        if (newsData.naverData) {
                            try {
                                naverData = JSON.parse(newsData.naverData);
                            } catch (error) {
                                console.error('Error parsing naverData:', error);
                            }
                        }

                        // ë‰´ìŠ¤ ë°ì´í„° í‘œì‹œ ë¶€ë¶„ ìˆ˜ì •
                        if (naverData && naverData.items && Array.isArray(naverData.items)) {
                            naverData.items.forEach(article => {
                                const newsItem = document.createElement('div');
                                newsItem.classList.add('news-item');
                                newsItem.innerHTML = `
                                <div class="news-content">
                                    <a href="${article.link}" target="_blank">${article.title}</a>
                                    <p>${article.description}</p>
                                </div>
                            `;
                                newsContainer.appendChild(newsItem);
                            });
                        } else {
                            console.error('News data is missing or invalid.');
                        }

                    })
                    .catch(newsError => {
                        console.error('Error fetching news:', newsError);
                    });

                // ratioResults êº¾ì€ì„  ê·¸ë˜í”„ ë Œë”ë§
                const ratioResults = data.ratioResults; // ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ratioResults ë°ì´í„°
                const ratiocon = document.getElementById('ratio-con');

                if (ratioResults && Array.isArray(ratioResults)) {
                    const labels = ratioResults.map(item => item.period);  // xì¶•ì— í‘œì‹œí•  ë‚ ì§œë“¤ (period)
                    const values = ratioResults.map(item => item.estimatedValue);  // yì¶•ì— í‘œì‹œí•  estimatedValue ê°’ë“¤

                    const ratioResultsChart = new Chart(document.getElementById('ratioResultsChart'), {
                        type: 'line',
                        data: {
                            labels: labels, // ë‚ ì§œë¥¼ xì¶•ì— ì‚¬ìš©
                            datasets: [{
                                label: 'Estimated Value',
                                data: values, // estimatedValueë¥¼ yì¶•ì— ì‚¬ìš©
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            scales: {
                                x: {
                                    display: true,
                                    title: {
                                        display: true,
                                        text: 'Date'
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    display: true,
                                    title: {
                                        display: true,
                                        text: 'Estimated Value'
                                    }
                                }
                            }
                        }
                    });
                } else {
                    console.error('Ratio results data is missing or invalid.');
                    ratiocon.innerHTML = 'api ìì²´ ë¬¸ì œë¡œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });


    });

    document.getElementById('excelButton').addEventListener('click', function () {
        if (!data) {
            alert("ë°ì´í„°ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”");
            return;
        }

        // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
        const loadingOverlay = document.getElementById('loadingOverlay');
        loadingOverlay.style.display = 'flex';

        const keywordSearchElement = document.querySelector('#keywordSearch');
        const keywordSearch = keywordSearchElement ? keywordSearchElement.innerText : 'default';

        const requestData = {
            ...data,
            keyword_search: keywordSearch,
        };

        fetch('/exportExcel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData),
        })
            .then(response => {
                if (response.status === 401) {
                    alert("íšŒì› ì „ìš© ê¸°ëŠ¥ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
                    window.location.href = "/login";
                    return;
                } else if (!response.ok) {
                    throw new Error("ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }

                const contentDisposition = response.headers.get('Content-Disposition');
                let fileName = 'export.xlsx'; // ê¸°ë³¸ íŒŒì¼ ì´ë¦„

                // Content-Dispositionì—ì„œ íŒŒì¼ ì´ë¦„ ì¶”ì¶œ
                if (contentDisposition) {
                    const matches = contentDisposition.match(/filename\*?=['"]?([^;'"]+)['"]?/);
                    if (matches && matches[1]) {
                        fileName = decodeURIComponent(matches[1].replace('UTF-8\'\'', ''));
                    }
                }

                return response.blob().then(blob => ({ blob, fileName }));
            })
            .then(({ blob, fileName }) => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.click();
                a.remove();
            })
            .catch(error => console.error('ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜:', error))
            .finally(() => {
            // ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
            loadingOverlay.style.display = 'none';
        });
    });

    function changeLanguage(lang) {
        const keywordSearch = document.getElementById('keywordSearch').textContent.trim() || 'defaultKeyword'; // textContentë¡œ ê°’ì„ ì½ì–´ì˜¤ê³ , ê¸°ë³¸ê°’ ì„¤ì •

        let newPath;
        // ì–¸ì–´ ì„ íƒì— ë”°ë¼ ì´ë™í•  ê²½ë¡œ ì„¤ì •
        if (lang === 'en') {
            newPath = `/searchKeyword_en?keyword_search=${encodeURIComponent(keywordSearch)}&lang=${lang}`;
        } else if (lang === 'ko') {
            newPath = `/searchKeyword?keyword_search=${encodeURIComponent(keywordSearch)}&lang=${lang}`;
        }

        // ì„ íƒëœ ì–¸ì–´ë¥¼ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
        localStorage.setItem('selectedLanguage', lang);

        // ìƒˆë¡œìš´ ê²½ë¡œë¡œ ì´ë™
        window.location.href = newPath;
    }

    window.addEventListener('DOMContentLoaded', () => {
        const languageSelect = document.getElementById('languageSelect');

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì €ì¥ëœ ì–¸ì–´ë¥¼ ê°€ì ¸ì˜´
        const savedLanguage = localStorage.getItem('selectedLanguage');

        if (savedLanguage) {
            languageSelect.value = savedLanguage;
        } else {
            languageSelect.value = 'en';
        }


        // URLì˜ lang íŒŒë¼ë¯¸í„° ë™ê¸°í™”
        const currentUrl = new URL(window.location.href, window.location.origin);
        currentUrl.searchParams.set('lang', languageSelect.value);
        window.history.replaceState({}, '', currentUrl.toString()); // ì „ì²´ URL í‘œì‹œ
    });



</script>
</body>
</html>
