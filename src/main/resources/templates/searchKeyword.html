<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  <!-- 반응형 웹을 위한 뷰포트 설정 -->
    <title>Issue Market</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/globals.css">
    <link rel="stylesheet" href="/css/substyle.css">
    <link rel="stylesheet" href="/css/searchKeyword.css">

    <!-- Chart.js 라이브러리 불러오기 (차트 렌더링을 위해 사용) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
<div class="header-wrapper" id="header-wrapper">
    <div class="menu-button-wrapper">
        <button type="button" class="btn btn-light" id="menu-button">
            <img class="img" src="https://c.animaapp.com/Z0sstfyg/img/list.svg" />
        </button>
        <button class="issue-market-title btn btn-link d-flex align-items-center" id="issue-market-title">
            <img src="/css/image/logo_black.png" alt="Logo" style="height: 60px; width: 110px; margin-left: 5px">
            <span>&nbsp;Issue Market</span>
        </button>
    </div>

    <!-- 로그인/로그아웃 버튼 설정 -->
    <div class="items">
        <button type="button" class="btn btn-danger" sec:authorize="hasAuthority('ADMIN')" onclick="location.href='/admin'">
            <div class="text-wrapper-17">관리자 페이지</div>
        </button>
        <button type="button" class="btn btn-dark" sec:authorize="isAuthenticated()" onclick="location.href='/logout'">
            <div class="text-wrapper-17">로그아웃</div>
        </button>
        <button type="button" class="btn btn-dark" sec:authorize="!isAuthenticated()" onclick="location.href='/login'">
            <div class="text-wrapper-17">로그인</div>
        </button>
    </div>
</div>

<div class="element-header-navigation">
    <div class="element-sidebar" id="sidebar">
        <div class="top-divider"></div> <!-- 사이드바 맨 위에 추가된 검은 줄 -->
        <div class="list-3">
            <button class="menu-item" id="home-button">
                <img class="img" src="https://c.animaapp.com/Z0sstfyg/img/home.svg" />
                <div class="text-wrapper-14">Home</div>
            </button>
            <button class="menu-item">
                <img class="img" src="https://c.animaapp.com/Z0sstfyg/img/search.svg" />
                <div class="text-wrapper-14">영화</div>
            </button>
            <button class="menu-item">
                <img class="img" src="https://c.animaapp.com/Z0sstfyg/img/radio-2.svg" />
                <div class="text-wrapper-14">음악</div>
            </button>
            <button class="menu-item" id="actor-button">
                <img class="img" src="https://c.animaapp.com/Z0sstfyg/img/radio-2.svg" />
                <div class="text-wrapper-14">배우</div>
            </button>
            <button class="menu-item" id="webtoon-button">
                <img class="img" src="https://c.animaapp.com/Z0sstfyg/img/radio-2.svg" />
                <div class="text-wrapper-14">웹툰</div>
            </button>
        </div>
    </div>
</div>

<div id="results">
    <!-- 상단 가로 3개 영역 -->
    <div class="row">
        <div class="col">
            <h3>Keyword Data</h3>
            <pre id="keywordData"></pre>
            <p th:text="${keyword_search}"></p>
        </div>
        <div class="col">
            <h3>Gender Ratio</h3>
            <div class="chart-container">
                <canvas id="genderChart" width="500" height="350"></canvas>
            </div>
        </div>
        <div class="col">
            <h3>Age Ratio</h3>
            <div class="chart-container">
                <canvas id="ageChart" width="500" height="350"></canvas>
            </div>
        </div>
    </div>

    <!-- 중간에 1개 영역 -->
    <div class="full-width">
        <h3>Ratio Results (Estimated Value by Date)</h3>
        <div class="chart-container">
            <canvas id="ratioResultsChart" width="1450" height="350"></canvas>
        </div>
    </div>

    <!-- 하단 가로 2개 영역 -->
    <div class="row">
        <div class="col">
            <h3>Related Keywords</h3>
            <div id="relatedKeywordsContainer" class="related-keywords"></div>
        </div>
        <div class="col">
            <h3>YouTube Video</h3>
            <div id="youtubeData">
                <iframe id="youtubeVideoFrame" width="560" height="315" frameborder="0" allowfullscreen></iframe>
                <p id="youtubeViewCount"></p>
            </div>
        </div>
    </div>
</div>

<!-- 뉴스 결과를 출력하는 영역 -->
<div id="newsResults">
    <div id="newsContainer"></div>  <!-- 뉴스 기사를 담는 컨테이너 -->
</div>
<button id="excelButton" class="btn btn-primary">엑셀로 내려받기</button>


<div id="overlay" class="overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:999;"></div>

<!-- 자바스크립트 코드 -->
<script th:inline="javascript">
    /*<![CDATA[*/
    const keyword_search = /*[[${keyword_search}]]*/ 'defaultKeyword';  // Thymeleaf로 전달된 키워드 변수 설정
    console.log(keyword_search);

    function saveKeyword(keyword) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/api/keywords", true); // 키워드 인코딩
        xhr.setRequestHeader("Content-Type", "application/json");
        var data = JSON.stringify({ keyword: keyword });

        xhr.onload = function() {
            if (xhr.status === 200) {
                console.log("Keyword saved successfully:", xhr.responseText);
            } else {
                console.error("Error saving keyword:", xhr.statusText);
            }
        };
        xhr.send(data);  // 요청 전송
    }
    // 페이지가 로드될 때 saveKeyword 호출
    document.addEventListener('DOMContentLoaded', function() {
        saveKeyword(keyword_search); // 기본 키워드를 저장
    });
    /*]]>*/
</script>
<script>
    let data = null;

    document.addEventListener('DOMContentLoaded', function() {
        // 요소 참조 및 이벤트 리스너 설정
        var menuButton = document.getElementById('menu-button');
        var sidebar = document.getElementById('sidebar');
        var overlay = document.getElementById('overlay');
        var issueMarketTitle = document.getElementById('issue-market-title');
        var homeButton = document.getElementById('home-button');

        menuButton.addEventListener('click', function() {
            sidebar.classList.toggle('sidebar-visible');
            overlay.classList.toggle('overlay-visible');
        });

        overlay.addEventListener('click', function() {
            sidebar.classList.remove('sidebar-visible');
            overlay.classList.remove('overlay-visible');
        });

        document.getElementById('actor-button').addEventListener('click', function() {
            window.location.href = '/actor'; // 배우 버튼 클릭 시 actor로 이동
        });

        document.getElementById('webtoon-button').addEventListener('click', function() {
            window.location.href = '/webtoon'; // 웹툰 버튼 클릭 시 webtoon으로 이동
        });

        issueMarketTitle.addEventListener('click', function() {
            window.location.href = 'index'; // 홈 버튼을 클릭하면 메인 화면으로 이동
        });

        homeButton.addEventListener('click', function() {
            window.location.href = 'index'; // 홈 버튼을 클릭하면 메인 화면으로 이동
        });

        // 검색어를 기반으로 데이터 호출
        fetch(`/search?groupName=${keyword_search}&keywords=${keyword_search}`, {
            method: 'POST'
        })
            .then(response => response.json())   // JSON 응답을 파싱
            .then(fetchedData => {
                data = fetchedData; // 전역 변수에 데이터 저장
                console.log(data); // 데이터를 콘솔에 출력하여 확인

                // 키워드 데이터 출력
                const keywordDataDiv = document.getElementById('keywordData');
                const pcCount = data.monthlyPcQcCnt;
                const mobileCount = data.monthlyMobileQcCnt;
                const totalCount = pcCount + mobileCount;

                // 키워드 통계 데이터를 화면에 표시
                keywordDataDiv.innerHTML = `
                    <div class="keyword-stats">
                        <div class="stat-item">
                            <span class="device-icon">💻</span>
                            <span class="stat-value">${pcCount.toLocaleString()}</span>
                            <span>PC</span>
                        </div>
                        <div class="stat-item">
                            <span class="device-icon">📱</span>
                            <span class="stat-value">${mobileCount.toLocaleString()}</span>
                            <span>Mobile</span>
                        </div>
                        <div class="stat-item">
                            <span class="device-icon">🔍</span>
                            <span class="stat-value">${totalCount.toLocaleString()}</span>
                            <span>Total</span>
                        </div>
                    </div>
            `;
                // 연관 검색어 데이터 표시
                const relatedKeywordsContainer = document.getElementById('relatedKeywordsContainer');
                const relatedKeywords = data.relatedKeywords;

                if (relatedKeywords && Array.isArray(relatedKeywords)) {
                    const ul = document.createElement('ul'); // <ul> 태그 생성

                    relatedKeywords.forEach((keyword, index) => {
                        const li = document.createElement('li'); // <li> 태그 생성
                        li.textContent = `${index + 1}. ${keyword}`; // 번호와 키워드 추가
                        ul.appendChild(li); // <li>를 <ul>에 추가
                    });

                    relatedKeywordsContainer.appendChild(ul); // <ul>을 컨테이너에 추가
                } else {
                    relatedKeywordsContainer.innerText = 'No related keywords available.';
                }

                // 성별 비율 차트 렌더링
                const genderData = data.kakaoData.gender;
                if (genderData) {
                    const genderChart = new Chart(document.getElementById('genderChart'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Male', 'Female'],
                            datasets: [{
                                data: [genderData.male, genderData.female],
                                backgroundColor: ['#36A2EB', '#FF6384']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true
                        }
                    });
                } else {
                    console.error('Gender data is missing or invalid.');
                }

                // 연령대 비율 차트 렌더링
                const ageData = data.kakaoData.age;
                if (ageData) {
                    const ageChart = new Chart(document.getElementById('ageChart'), {
                        type: 'bar',
                        data: {
                            labels: Object.keys(ageData),
                            datasets: [{
                                label: 'Age Distribution',
                                data: Object.values(ageData),
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                } else {
                    console.error('Age data is missing or invalid.');
                }

                // 유튜브 데이터 표시 로직 추가
                const youtubeData = data.youtubeData;
                if (youtubeData && !youtubeData.error) {
                    const youtubeVideoFrame = document.getElementById('youtubeVideoFrame');
                    const youtubeViewCountElement = document.getElementById('youtubeViewCount');

                    // 유튜브 임베드 URL 설정
                    const videoId = youtubeData.videoUrl.split("v=")[1];
                    const embedUrl = `https://www.youtube.com/embed/${videoId}`;
                    youtubeVideoFrame.src = embedUrl;

                    // 조회수 표시
                    youtubeViewCountElement.textContent = `View Count: ${youtubeData.viewCount.toLocaleString()}`;
                } else {
                    console.error('YouTube data is missing or invalid.');
                    document.getElementById('youtubeData').textContent = 'Failed to load YouTube data.';
                }

                // 뉴스 API 호출
                fetch(`/news?query=${keyword_search}`)
                    .then(newsResponse => newsResponse.json())
                    .then(newsData => {
                        const newsContainer = document.getElementById('newsContainer');

                        // JSON 파싱 및 데이터 출력
                        let naverData = null;
                        if (newsData.naverData) {
                            try {
                                naverData = JSON.parse(newsData.naverData);
                            } catch (error) {
                                console.error('Error parsing naverData:', error);
                            }
                        }

                        // 뉴스 데이터 표시 부분 수정
                        if (naverData && naverData.items && Array.isArray(naverData.items)) {
                            naverData.items.forEach(article => {
                                const newsItem = document.createElement('div');
                                newsItem.classList.add('news-item');
                                newsItem.innerHTML = `
                                <div class="news-content">
                                    <a href="${article.link}" target="_blank">${article.title}</a>
                                    <p>${article.description}</p>
                                </div>
                            `;
                                newsContainer.appendChild(newsItem);
                            });
                        } else {
                            console.error('News data is missing or invalid.');
                        }

                    })
                    .catch(newsError => {
                        console.error('Error fetching news:', newsError);
                    });

                // ratioResults 꺾은선 그래프 렌더링
                const ratioResults = data.ratioResults; // 서버에서 가져온 ratioResults 데이터

                if (ratioResults && Array.isArray(ratioResults)) {
                    const labels = ratioResults.map(item => item.period);  // x축에 표시할 날짜들 (period)
                    const values = ratioResults.map(item => item.estimatedValue);  // y축에 표시할 estimatedValue 값들

                    const ratioResultsChart = new Chart(document.getElementById('ratioResultsChart'), {
                        type: 'line',
                        data: {
                            labels: labels, // 날짜를 x축에 사용
                            datasets: [{
                                label: 'Estimated Value',
                                data: values, // estimatedValue를 y축에 사용
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            scales: {
                                x: {
                                    display: true,
                                    title: {
                                        display: true,
                                        text: 'Date'
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    display: true,
                                    title: {
                                        display: true,
                                        text: 'Estimated Value'
                                    }
                                }
                            }
                        }
                    });
                } else {
                    console.error('Ratio results data is missing or invalid.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });


    });

    //엑셀 다운로드 버튼 클릭 이벤트
    document.getElementById('excelButton').addEventListener('click',function (){
        if (!data) { // data가 로드되었는지 확인
            alert("데이터가 아직 로드되지 않았습니다. 잠시 후 다시 시도해주세요");
            return;
        }

        //엑셀 파일 다운로드 요청
        fetch('/exportExcel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data) // 전체 data 전송
        })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'data_export.xlsx';
                a.click();
                a.remove();
            })
            .catch(error => console.error('엑셀 내보내기 중 오류',error));
    })


</script>
</body>
</html>
