<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  <!-- ë°˜ì‘í˜• ì›¹ì„ ìœ„í•œ ë·°í¬íŠ¸ ì„¤ì • -->
    <title>Issue Market</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/globals.css">
    <link rel="stylesheet" href="/css/substyle.css">
    <link rel="stylesheet" href="/css/searchKeyword.css">

    <!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° (ì°¨íŠ¸ ë Œë”ë§ì„ ìœ„í•´ ì‚¬ìš©) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
<div class="header-wrapper" id="header-wrapper">
    <div class="menu-button-wrapper">
        <button type="button" class="btn btn-light" id="menu-button">
            <img class="img" src="https://c.animaapp.com/Z0sstfyg/img/list.svg" />
        </button>
        <button class="issue-market-title btn btn-link d-flex align-items-center" id="issue-market-title">
            <img src="/css/image/logo_black.png" alt="Logo" style="height: 60px; width: 110px; margin-left: 5px">
            <span>&nbsp;Issue Market</span>
        </button>
    </div>

    <!-- ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì„¤ì • -->
    <div class="items">
        <button type="button" class="btn btn-danger" sec:authorize="hasAuthority('ADMIN')" onclick="location.href='/admin'">
            <div class="text-wrapper-17">ê´€ë¦¬ì í˜ì´ì§€</div>
        </button>
        <button type="button" class="btn btn-dark" sec:authorize="isAuthenticated()" onclick="location.href='/logout'">
            <div class="text-wrapper-17">ë¡œê·¸ì•„ì›ƒ</div>
        </button>
        <button type="button" class="btn btn-dark" sec:authorize="!isAuthenticated()" onclick="location.href='/login'">
            <div class="text-wrapper-17">ë¡œê·¸ì¸</div>
        </button>
    </div>
</div>

<div class="element-header-navigation">
    <div class="element-sidebar" id="sidebar">
        <div class="top-divider"></div> <!-- ì‚¬ì´ë“œë°” ë§¨ ìœ„ì— ì¶”ê°€ëœ ê²€ì€ ì¤„ -->
        <div class="list-3">
            <button class="menu-item" id="home-button">
                <img class="img" src="https://c.animaapp.com/Z0sstfyg/img/home.svg" />
                <div class="text-wrapper-14">Home</div>
            </button>
            <button class="menu-item">
                <img class="img" src="https://c.animaapp.com/Z0sstfyg/img/search.svg" />
                <div class="text-wrapper-14">ì˜í™”</div>
            </button>
            <button class="menu-item">
                <img class="img" src="https://c.animaapp.com/Z0sstfyg/img/radio-2.svg" />
                <div class="text-wrapper-14">ìŒì•…</div>
            </button>
            <button class="menu-item" id="actor-button">
                <img class="img" src="https://c.animaapp.com/Z0sstfyg/img/radio-2.svg" />
                <div class="text-wrapper-14">ë°°ìš°</div>
            </button>
            <button class="menu-item" id="webtoon-button">
                <img class="img" src="https://c.animaapp.com/Z0sstfyg/img/radio-2.svg" />
                <div class="text-wrapper-14">ì›¹íˆ°</div>
            </button>
        </div>

        <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¹ì…˜ (ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ì ‘ê·¼ ê°€ëŠ¥) -->
        <div class="list-4" sec:authorize="isAuthenticated()">
            <div class="library-header">Library</div>
            <button class="menu-item">
                <img class="img" src="https://c.animaapp.com/Z0sstfyg/img/list.svg" />
                <div class="text-wrapper-14">í•„í„°ë§</div>
            </button>
            <button class="menu-item">
                <img class="img" src="https://c.animaapp.com/Z0sstfyg/img/music.svg" />
                <div class="text-wrapper-14">ì¦ê²¨ì°¾ê¸°</div>
            </button>
        </div>
    </div>
</div>

<!-- ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì¶œë ¥í•˜ëŠ” ì˜ì—­ -->
<div id="results">
    <div>
        <h3>Keyword Data</h3>
        <pre id="keywordData"></pre>
        <p th:text="${keyword_search}"></p>
    </div>
    <div>
        <h3>Gender Ratio</h3>
        <div class="chart-container">
            <canvas id="genderChart" width="500" height="350"></canvas> <!-- ì„±ë³„ ë¹„ìœ¨ ì°¨íŠ¸ -->
        </div>
    </div>
    <div>
        <h3>Age Ratio</h3>
        <div class="chart-container">
            <canvas id="ageChart" width="500" height="350"></canvas>    <!-- ì—°ë ¹ëŒ€ ë¹„ìœ¨ ì°¨íŠ¸ -->
        </div>
    </div>
    <div>
        <h3>Ratio Results (Estimated Value by Date)</h3>
        <div class="chart-container">
            <canvas id="ratioResultsChart" width="500" height="350"></canvas> <!-- ë‚ ì§œë³„ ì¶”ì„¸ë¥¼ ë‚˜íƒ€ë‚¼ êº¾ì€ì„  ê·¸ë˜í”„ -->
        </div>
    </div>
</div>



<!-- ë‰´ìŠ¤ ê²°ê³¼ë¥¼ ì¶œë ¥í•˜ëŠ” ì˜ì—­ -->
<div id="newsResults">

    <div id="newsContainer"></div>  <!-- ë‰´ìŠ¤ ê¸°ì‚¬ë¥¼ ë‹´ëŠ” ì»¨í…Œì´ë„ˆ -->
</div>


<div id="overlay" class="overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:999;"></div>

<!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œ -->
<script th:inline="javascript">
    /*<![CDATA[*/
    const keyword_search = /*[[${keyword_search}]]*/ 'defaultKeyword';  // Thymeleafë¡œ ì „ë‹¬ëœ í‚¤ì›Œë“œ ë³€ìˆ˜ ì„¤ì •
    console.log(keyword_search);

    function saveKeyword(keyword) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/api/keywords", true); // í‚¤ì›Œë“œ ì¸ì½”ë”©
        xhr.setRequestHeader("Content-Type", "application/json");
        var data = JSON.stringify({ keyword: keyword });

        xhr.onload = function() {
            if (xhr.status === 200) {
                console.log("Keyword saved successfully:", xhr.responseText);
            } else {
                console.error("Error saving keyword:", xhr.statusText);
            }
        };
        xhr.send(data);  // ìš”ì²­ ì „ì†¡
    }
    // í˜ì´ì§€ê°€ ë¡œë“œë  ë•Œ saveKeyword í˜¸ì¶œ
    document.addEventListener('DOMContentLoaded', function() {
        saveKeyword(keyword_search); // ê¸°ë³¸ í‚¤ì›Œë“œë¥¼ ì €ì¥
    });
    /*]]>*/
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ìš”ì†Œ ì°¸ì¡° ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        var menuButton = document.getElementById('menu-button');
        var sidebar = document.getElementById('sidebar');
        var overlay = document.getElementById('overlay');
        var issueMarketTitle = document.getElementById('issue-market-title');
        var homeButton = document.getElementById('home-button');

        menuButton.addEventListener('click', function() {
            sidebar.classList.toggle('sidebar-visible');
            overlay.classList.toggle('overlay-visible');
        });

        overlay.addEventListener('click', function() {
            sidebar.classList.remove('sidebar-visible');
            overlay.classList.remove('overlay-visible');
        });

        document.getElementById('actor-button').addEventListener('click', function() {
            window.location.href = '/actor'; // ë°°ìš° ë²„íŠ¼ í´ë¦­ ì‹œ actorë¡œ ì´ë™
        });

        document.getElementById('webtoon-button').addEventListener('click', function() {
            window.location.href = '/webtoon'; // ì›¹íˆ° ë²„íŠ¼ í´ë¦­ ì‹œ webtoonìœ¼ë¡œ ì´ë™
        });

        issueMarketTitle.addEventListener('click', function() {
            window.location.href = 'index'; // í™ˆ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
        });

        homeButton.addEventListener('click', function() {
            window.location.href = 'index'; // í™ˆ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
        });

        // ê²€ìƒ‰ì–´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë°ì´í„° í˜¸ì¶œ
        fetch(`/search?groupName=${keyword_search}&keywords=${keyword_search}`, {
            method: 'POST'
        })
            .then(response => response.json())   // JSON ì‘ë‹µì„ íŒŒì‹±
            .then(data => {
                console.log(data); // ë°ì´í„°ë¥¼ ì½˜ì†”ì— ì¶œë ¥í•˜ì—¬ í™•ì¸

                // í‚¤ì›Œë“œ ë°ì´í„° ì¶œë ¥
                const keywordDataDiv = document.getElementById('keywordData');
                const pcCount = data.monthlyPcQcCnt;
                const mobileCount = data.monthlyMobileQcCnt;
                const totalCount = pcCount + mobileCount;

                // í‚¤ì›Œë“œ í†µê³„ ë°ì´í„°ë¥¼ í™”ë©´ì— í‘œì‹œ
                keywordDataDiv.innerHTML = `
                    <div class="keyword-stats">
                        <div class="stat-item">
                            <span class="device-icon">ğŸ’»</span>
                            <span class="stat-value">${pcCount.toLocaleString()}</span>
                            <span>PC</span>
                        </div>
                        <div class="stat-item">
                            <span class="device-icon">ğŸ“±</span>
                            <span class="stat-value">${mobileCount.toLocaleString()}</span>
                            <span>Mobile</span>
                        </div>
                        <div class="stat-item">
                            <span class="device-icon">ğŸ”</span>
                            <span class="stat-value">${totalCount.toLocaleString()}</span>
                            <span>Total</span>
                        </div>
                    </div>
            `;

                // ì„±ë³„ ë¹„ìœ¨ ì°¨íŠ¸ ë Œë”ë§
                const genderData = data.kakaoData.gender;
                if (genderData) {
                    const genderChart = new Chart(document.getElementById('genderChart'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Male', 'Female'],
                            datasets: [{
                                data: [genderData.male, genderData.female],
                                backgroundColor: ['#36A2EB', '#FF6384']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true
                        }
                    });
                } else {
                    console.error('Gender data is missing or invalid.');
                }

                // ì—°ë ¹ëŒ€ ë¹„ìœ¨ ì°¨íŠ¸ ë Œë”ë§
                const ageData = data.kakaoData.age;
                if (ageData) {
                    const ageChart = new Chart(document.getElementById('ageChart'), {
                        type: 'bar',
                        data: {
                            labels: Object.keys(ageData),
                            datasets: [{
                                label: 'Age Distribution',
                                data: Object.values(ageData),
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                } else {
                    console.error('Age data is missing or invalid.');
                }

                // ë‰´ìŠ¤ API í˜¸ì¶œ
                fetch(`/news?query=${keyword_search}`)
                    .then(newsResponse => newsResponse.json())
                    .then(newsData => {
                        const newsContainer = document.getElementById('newsContainer');

                        // JSON íŒŒì‹± ë° ë°ì´í„° ì¶œë ¥
                        let naverData = null;
                        if (newsData.naverData) {
                            try {
                                naverData = JSON.parse(newsData.naverData);
                            } catch (error) {
                                console.error('Error parsing naverData:', error);
                            }
                        }

                        // ë‰´ìŠ¤ ë°ì´í„° í‘œì‹œ ë¶€ë¶„ ìˆ˜ì •
                        if (naverData && naverData.items && Array.isArray(naverData.items)) {
                            naverData.items.forEach(article => {
                                const newsItem = document.createElement('div');
                                newsItem.classList.add('news-item');
                                newsItem.innerHTML = `
                                <div class="news-content">
                                    <a href="${article.link}" target="_blank">${article.title}</a>
                                    <p>${article.description}</p>
                                </div>
                            `;
                                newsContainer.appendChild(newsItem);
                            });
                        } else {
                            console.error('News data is missing or invalid.');
                        }

                    })
                    .catch(newsError => {
                        console.error('Error fetching news:', newsError);
                    });

                // ratioResults êº¾ì€ì„  ê·¸ë˜í”„ ë Œë”ë§
                const ratioResults = data.ratioResults; // ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ratioResults ë°ì´í„°

                if (ratioResults && Array.isArray(ratioResults)) {
                    const labels = ratioResults.map(item => item.period);  // xì¶•ì— í‘œì‹œí•  ë‚ ì§œë“¤ (period)
                    const values = ratioResults.map(item => item.estimatedValue);  // yì¶•ì— í‘œì‹œí•  estimatedValue ê°’ë“¤

                    const ratioResultsChart = new Chart(document.getElementById('ratioResultsChart'), {
                        type: 'line',
                        data: {
                            labels: labels, // ë‚ ì§œë¥¼ xì¶•ì— ì‚¬ìš©
                            datasets: [{
                                label: 'Estimated Value',
                                data: values, // estimatedValueë¥¼ yì¶•ì— ì‚¬ìš©
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            scales: {
                                x: {
                                    display: true,
                                    title: {
                                        display: true,
                                        text: 'Date'
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    display: true,
                                    title: {
                                        display: true,
                                        text: 'Estimated Value'
                                    }
                                }
                            }
                        }
                    });
                } else {
                    console.error('Ratio results data is missing or invalid.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });

    });


</script>
</body>
</html>
