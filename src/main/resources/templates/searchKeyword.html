<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  <!-- ë°˜ì‘í˜• ì›¹ì„ ìœ„í•œ ë·°í¬íŠ¸ ì„¤ì • -->
    <title>Issue Market</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/globals.css">
    <link rel="stylesheet" href="/css/substyle.css">
    <link rel="stylesheet" href="/css/searchKeyword.css">

    <!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° (ì°¨íŠ¸ ë Œë”ë§ì„ ìœ„í•´ ì‚¬ìš©) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
<div class="header-wrapper" id="header-wrapper">
    <div class="menu-button-wrapper">
        <button type="button" class="btn btn-light" id="menu-button">
            <img class="img" src="https://c.animaapp.com/Z0sstfyg/img/list.svg" />
        </button>
        <button class="issue-market-title btn btn-link d-flex align-items-center" id="issue-market-title">
            <img src="/css/image/logo_black.png" alt="Logo" style="height: 60px; width: 110px; margin-left: 5px">
            <span>&nbsp;Issue Market</span>
        </button>
    </div>

    <!-- ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì„¤ì • -->
    <div class="items">
        <button type="button" class="btn btn-danger" sec:authorize="hasAuthority('ADMIN')" onclick="location.href='/admin'">
            <div class="text-wrapper-17">ê´€ë¦¬ì í˜ì´ì§€</div>
        </button>
        <button type="button" class="btn btn-dark" sec:authorize="isAuthenticated()" onclick="location.href='/logout'">
            <div class="text-wrapper-17">ë¡œê·¸ì•„ì›ƒ</div>
        </button>
        <button type="button" class="btn btn-dark" sec:authorize="!isAuthenticated()" onclick="location.href='/login'">
            <div class="text-wrapper-17">ë¡œê·¸ì¸</div>
        </button>
    </div>
</div>

<div class="element-header-navigation">
    <div class="element-sidebar" id="sidebar">
        <div class="top-divider"></div> <!-- ì‚¬ì´ë“œë°” ë§¨ ìœ„ì— ì¶”ê°€ëœ ê²€ì€ ì¤„ -->
        <div class="list-3">
            <button class="menu-item" id="home-button">
                <img class="img" src="https://c.animaapp.com/Z0sstfyg/img/home.svg" />
                <div class="text-wrapper-14">Home</div>
            </button>
            <button class="menu-item">
                <img class="img" src="https://c.animaapp.com/Z0sstfyg/img/search.svg" />
                <div class="text-wrapper-14">ì˜í™”</div>
            </button>
            <button class="menu-item">
                <img class="img" src="https://c.animaapp.com/Z0sstfyg/img/radio-2.svg" />
                <div class="text-wrapper-14">ìŒì•…</div>
            </button>
            <button class="menu-item" id="actor-button">
                <img class="img" src="https://c.animaapp.com/Z0sstfyg/img/radio-2.svg" />
                <div class="text-wrapper-14">ë°°ìš°</div>
            </button>
            <button class="menu-item" id="webtoon-button">
                <img class="img" src="https://c.animaapp.com/Z0sstfyg/img/radio-2.svg" />
                <div class="text-wrapper-14">ì›¹íˆ°</div>
            </button>
        </div>
    </div>
</div>

<div id="results">
    <!-- ìƒë‹¨ ê°€ë¡œ 3ê°œ ì˜ì—­ -->
    <div class="row">
        <div class="col">
            <h3>Keyword Data</h3>
            <pre id="keywordData"></pre>
            <p th:text="${keyword_search}"></p>
        </div>
        <div class="col">
            <h3>Gender Ratio</h3>
            <div class="chart-container">
                <canvas id="genderChart" width="500" height="350"></canvas>
            </div>
        </div>
        <div class="col">
            <h3>Age Ratio</h3>
            <div class="chart-container">
                <canvas id="ageChart" width="500" height="350"></canvas>
            </div>
        </div>
    </div>

    <!-- ì¤‘ê°„ì— 1ê°œ ì˜ì—­ -->
    <div class="full-width">
        <h3>Ratio Results (Estimated Value by Date)</h3>
        <div class="chart-container">
            <canvas id="ratioResultsChart" width="1450" height="350"></canvas>
        </div>
    </div>

    <!-- í•˜ë‹¨ ê°€ë¡œ 2ê°œ ì˜ì—­ -->
    <div class="row">
        <div class="col">
            <h3>Related Keywords</h3>
            <div id="relatedKeywordsContainer" class="related-keywords"></div>
        </div>
        <div class="col">
            <h3>YouTube Video</h3>
            <div id="youtubeData">
                <iframe id="youtubeVideoFrame" width="560" height="315" frameborder="0" allowfullscreen></iframe>
                <p id="youtubeViewCount"></p>
            </div>
        </div>
    </div>
</div>

<!-- ë‰´ìŠ¤ ê²°ê³¼ë¥¼ ì¶œë ¥í•˜ëŠ” ì˜ì—­ -->
<div id="newsResults">
    <div id="newsContainer"></div>  <!-- ë‰´ìŠ¤ ê¸°ì‚¬ë¥¼ ë‹´ëŠ” ì»¨í…Œì´ë„ˆ -->
</div>
<button id="excelButton" class="btn btn-primary">ì—‘ì…€ë¡œ ë‚´ë ¤ë°›ê¸°</button>


<div id="overlay" class="overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:999;"></div>

<!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œ -->
<script th:inline="javascript">
    /*<![CDATA[*/
    const keyword_search = /*[[${keyword_search}]]*/ 'defaultKeyword';  // Thymeleafë¡œ ì „ë‹¬ëœ í‚¤ì›Œë“œ ë³€ìˆ˜ ì„¤ì •
    console.log(keyword_search);

    function saveKeyword(keyword) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/api/keywords", true); // í‚¤ì›Œë“œ ì¸ì½”ë”©
        xhr.setRequestHeader("Content-Type", "application/json");
        var data = JSON.stringify({ keyword: keyword });

        xhr.onload = function() {
            if (xhr.status === 200) {
                console.log("Keyword saved successfully:", xhr.responseText);
            } else {
                console.error("Error saving keyword:", xhr.statusText);
            }
        };
        xhr.send(data);  // ìš”ì²­ ì „ì†¡
    }
    // í˜ì´ì§€ê°€ ë¡œë“œë  ë•Œ saveKeyword í˜¸ì¶œ
    document.addEventListener('DOMContentLoaded', function() {
        saveKeyword(keyword_search); // ê¸°ë³¸ í‚¤ì›Œë“œë¥¼ ì €ì¥
    });
    /*]]>*/
</script>
<script>
    let data = null;

    document.addEventListener('DOMContentLoaded', function() {
        // ìš”ì†Œ ì°¸ì¡° ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        var menuButton = document.getElementById('menu-button');
        var sidebar = document.getElementById('sidebar');
        var overlay = document.getElementById('overlay');
        var issueMarketTitle = document.getElementById('issue-market-title');
        var homeButton = document.getElementById('home-button');

        menuButton.addEventListener('click', function() {
            sidebar.classList.toggle('sidebar-visible');
            overlay.classList.toggle('overlay-visible');
        });

        overlay.addEventListener('click', function() {
            sidebar.classList.remove('sidebar-visible');
            overlay.classList.remove('overlay-visible');
        });

        document.getElementById('actor-button').addEventListener('click', function() {
            window.location.href = '/actor'; // ë°°ìš° ë²„íŠ¼ í´ë¦­ ì‹œ actorë¡œ ì´ë™
        });

        document.getElementById('webtoon-button').addEventListener('click', function() {
            window.location.href = '/webtoon'; // ì›¹íˆ° ë²„íŠ¼ í´ë¦­ ì‹œ webtoonìœ¼ë¡œ ì´ë™
        });

        issueMarketTitle.addEventListener('click', function() {
            window.location.href = 'index'; // í™ˆ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
        });

        homeButton.addEventListener('click', function() {
            window.location.href = 'index'; // í™ˆ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
        });

        // ê²€ìƒ‰ì–´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë°ì´í„° í˜¸ì¶œ
        fetch(`/search?groupName=${keyword_search}&keywords=${keyword_search}`, {
            method: 'POST'
        })
            .then(response => response.json())   // JSON ì‘ë‹µì„ íŒŒì‹±
            .then(fetchedData => {
                data = fetchedData; // ì „ì—­ ë³€ìˆ˜ì— ë°ì´í„° ì €ì¥
                console.log(data); // ë°ì´í„°ë¥¼ ì½˜ì†”ì— ì¶œë ¥í•˜ì—¬ í™•ì¸

                // í‚¤ì›Œë“œ ë°ì´í„° ì¶œë ¥
                const keywordDataDiv = document.getElementById('keywordData');
                const pcCount = data.monthlyPcQcCnt;
                const mobileCount = data.monthlyMobileQcCnt;
                const totalCount = pcCount + mobileCount;

                // í‚¤ì›Œë“œ í†µê³„ ë°ì´í„°ë¥¼ í™”ë©´ì— í‘œì‹œ
                keywordDataDiv.innerHTML = `
                    <div class="keyword-stats">
                        <div class="stat-item">
                            <span class="device-icon">ğŸ’»</span>
                            <span class="stat-value">${pcCount.toLocaleString()}</span>
                            <span>PC</span>
                        </div>
                        <div class="stat-item">
                            <span class="device-icon">ğŸ“±</span>
                            <span class="stat-value">${mobileCount.toLocaleString()}</span>
                            <span>Mobile</span>
                        </div>
                        <div class="stat-item">
                            <span class="device-icon">ğŸ”</span>
                            <span class="stat-value">${totalCount.toLocaleString()}</span>
                            <span>Total</span>
                        </div>
                    </div>
            `;
                // ì—°ê´€ ê²€ìƒ‰ì–´ ë°ì´í„° í‘œì‹œ
                const relatedKeywordsContainer = document.getElementById('relatedKeywordsContainer');
                const relatedKeywords = data.relatedKeywords;

                if (relatedKeywords && Array.isArray(relatedKeywords)) {
                    const ul = document.createElement('ul'); // <ul> íƒœê·¸ ìƒì„±

                    relatedKeywords.forEach((keyword, index) => {
                        const li = document.createElement('li'); // <li> íƒœê·¸ ìƒì„±
                        li.textContent = `${index + 1}. ${keyword}`; // ë²ˆí˜¸ì™€ í‚¤ì›Œë“œ ì¶”ê°€
                        ul.appendChild(li); // <li>ë¥¼ <ul>ì— ì¶”ê°€
                    });

                    relatedKeywordsContainer.appendChild(ul); // <ul>ì„ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
                } else {
                    relatedKeywordsContainer.innerText = 'No related keywords available.';
                }

                // ì„±ë³„ ë¹„ìœ¨ ì°¨íŠ¸ ë Œë”ë§
                const genderData = data.kakaoData.gender;
                if (genderData) {
                    const genderChart = new Chart(document.getElementById('genderChart'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Male', 'Female'],
                            datasets: [{
                                data: [genderData.male, genderData.female],
                                backgroundColor: ['#36A2EB', '#FF6384']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true
                        }
                    });
                } else {
                    console.error('Gender data is missing or invalid.');
                }

                // ì—°ë ¹ëŒ€ ë¹„ìœ¨ ì°¨íŠ¸ ë Œë”ë§
                const ageData = data.kakaoData.age;
                if (ageData) {
                    const ageChart = new Chart(document.getElementById('ageChart'), {
                        type: 'bar',
                        data: {
                            labels: Object.keys(ageData),
                            datasets: [{
                                label: 'Age Distribution',
                                data: Object.values(ageData),
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                } else {
                    console.error('Age data is missing or invalid.');
                }

                // ìœ íŠœë¸Œ ë°ì´í„° í‘œì‹œ ë¡œì§ ì¶”ê°€
                const youtubeData = data.youtubeData;
                if (youtubeData && !youtubeData.error) {
                    const youtubeVideoFrame = document.getElementById('youtubeVideoFrame');
                    const youtubeViewCountElement = document.getElementById('youtubeViewCount');

                    // ìœ íŠœë¸Œ ì„ë² ë“œ URL ì„¤ì •
                    const videoId = youtubeData.videoUrl.split("v=")[1];
                    const embedUrl = `https://www.youtube.com/embed/${videoId}`;
                    youtubeVideoFrame.src = embedUrl;

                    // ì¡°íšŒìˆ˜ í‘œì‹œ
                    youtubeViewCountElement.textContent = `View Count: ${youtubeData.viewCount.toLocaleString()}`;
                } else {
                    console.error('YouTube data is missing or invalid.');
                    document.getElementById('youtubeData').textContent = 'Failed to load YouTube data.';
                }

                // ë‰´ìŠ¤ API í˜¸ì¶œ
                fetch(`/news?query=${keyword_search}`)
                    .then(newsResponse => newsResponse.json())
                    .then(newsData => {
                        const newsContainer = document.getElementById('newsContainer');

                        // JSON íŒŒì‹± ë° ë°ì´í„° ì¶œë ¥
                        let naverData = null;
                        if (newsData.naverData) {
                            try {
                                naverData = JSON.parse(newsData.naverData);
                            } catch (error) {
                                console.error('Error parsing naverData:', error);
                            }
                        }

                        // ë‰´ìŠ¤ ë°ì´í„° í‘œì‹œ ë¶€ë¶„ ìˆ˜ì •
                        if (naverData && naverData.items && Array.isArray(naverData.items)) {
                            naverData.items.forEach(article => {
                                const newsItem = document.createElement('div');
                                newsItem.classList.add('news-item');
                                newsItem.innerHTML = `
                                <div class="news-content">
                                    <a href="${article.link}" target="_blank">${article.title}</a>
                                    <p>${article.description}</p>
                                </div>
                            `;
                                newsContainer.appendChild(newsItem);
                            });
                        } else {
                            console.error('News data is missing or invalid.');
                        }

                    })
                    .catch(newsError => {
                        console.error('Error fetching news:', newsError);
                    });

                // ratioResults êº¾ì€ì„  ê·¸ë˜í”„ ë Œë”ë§
                const ratioResults = data.ratioResults; // ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ratioResults ë°ì´í„°

                if (ratioResults && Array.isArray(ratioResults)) {
                    const labels = ratioResults.map(item => item.period);  // xì¶•ì— í‘œì‹œí•  ë‚ ì§œë“¤ (period)
                    const values = ratioResults.map(item => item.estimatedValue);  // yì¶•ì— í‘œì‹œí•  estimatedValue ê°’ë“¤

                    const ratioResultsChart = new Chart(document.getElementById('ratioResultsChart'), {
                        type: 'line',
                        data: {
                            labels: labels, // ë‚ ì§œë¥¼ xì¶•ì— ì‚¬ìš©
                            datasets: [{
                                label: 'Estimated Value',
                                data: values, // estimatedValueë¥¼ yì¶•ì— ì‚¬ìš©
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            scales: {
                                x: {
                                    display: true,
                                    title: {
                                        display: true,
                                        text: 'Date'
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    display: true,
                                    title: {
                                        display: true,
                                        text: 'Estimated Value'
                                    }
                                }
                            }
                        }
                    });
                } else {
                    console.error('Ratio results data is missing or invalid.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });


    });

    //ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document.getElementById('excelButton').addEventListener('click',function (){
        if (!data) { // dataê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
            alert("ë°ì´í„°ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”");
            return;
        }

        //ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ìš”ì²­
        fetch('/exportExcel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data) // ì „ì²´ data ì „ì†¡
        })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'data_export.xlsx';
                a.click();
                a.remove();
            })
            .catch(error => console.error('ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜',error));
    })


</script>
</body>
</html>
